function P=fit_exclude_outliers(y,x,threshold,x0_range,k_range,verbose)

x_slope=NaN(numel(x),numel(x));
x_slope_bk=x_slope;
x_x0=NaN(numel(x),numel(x));
x_x0_bk=x_x0;
for i=1:1:length(x)
    if x(i) == 0
        continue;
    end
    for j=i+1:1:length(x)
        if x(j) == 0
            continue;
        end
        x_slope(i,j)=(x(j)-x(i))/(j-i);
        x_x0(i,j)=x(i)-x_slope(i,j)*i;
        x_slope_bk(i,j)=x_slope(i,j);
        x_slope_bk(j,i)=x_slope(i,j);
        x_x0_bk(i,j)=x_x0(i,j);
        x_x0_bk(j,i)=x_x0(i,j);
    end
end

x_slope=x_slope(~isnan(x_slope));
x_slope_r=min(x_slope):1:max(x_slope);
x_slope_h=hist(x_slope,x_slope_r);
if verbose~=0
    subplot(2,2,1);
    plot(x_slope_r,x_slope_h);
end
x_x0=x_x0(~isnan(x_x0));
max_x_x0=max(x_x0);
min_x_x0=min(x_x0);

if numel(x0_range)==2
    max_x_x0=x0_range(2);
    min_x_x0=x0_range(1);
end
step=(max_x_x0-min_x_x0)/100;
x_x0_r=min(x_x0):step:max(x_x0);
x_x0_h=hist(x_x0,x_x0_r);
if verbose~=0
    subplot(2,2,2);
    plot(x_x0_r,x_x0_h);
end

% now we need to find the most popular x0 and k
[x_slope_max,x_slope_index]=max(x_slope_h);
[x_x0_max,x_x0_index]=max(x_x0_h);
x0=x_x0_r(x_x0_index);
k=x_slope_r(x_slope_index);

x_predicted=y*k+x0;

if verbose~=0
    subplot(2,2,3);
    hold all;
    plot(x,'o');
    plot(x_predicted);
end

% apparently this is not enough, 
% we need to fit the curve using useful datapoints

distance=abs(x_predicted-x)./x;
y_corrected=y(distance<threshold);
x_corrected=x(distance<threshold);
P = polyfit(y_corrected,x_corrected,1);
if verbose~=0
    subplot(2,2,4);
    hold all
    plot(y_corrected,x_corrected,'o');
    plot(y,P(2)+y*P(1))
end

end